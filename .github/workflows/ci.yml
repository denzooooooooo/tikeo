name: CI/CD Pipeline â€” Tike'o

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 1 : Lint & vÃ©rification du code
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint || true

      - name: Type check
        run: npm run type-check || true

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 2 : Build du backend (vÃ©rification)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build-backend:
    name: Build Backend
    runs-on: ubuntu-latest
    needs: lint

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma client
        run: cd services/api-gateway && npx prisma generate

      - name: Build packages
        run: |
          npm run build --workspace=packages/types || true
          npm run build --workspace=packages/utils || true

      - name: Build API Gateway
        run: npm run build --workspace=services/api-gateway

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 3 : Deploy Backend sur VPS Hetzner
  # (uniquement sur push vers main)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: Deploy Backend â†’ VPS Hetzner
    runs-on: ubuntu-latest
    needs: build-backend
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT || 22 }}
          script: |
            set -e
            echo "ğŸ“¦ Mise Ã  jour du code..."
            cd /opt/tikeo
            git pull origin main

            echo "ğŸ³ Build et redÃ©marrage des containers..."
            docker-compose -f docker-compose.vps.yml build --no-cache api-gateway
            docker-compose -f docker-compose.vps.yml up -d --force-recreate api-gateway

            echo "ğŸ”„ Migration de la base de donnÃ©es..."
            docker-compose -f docker-compose.vps.yml exec -T api-gateway \
              sh -c "cd /app && npx prisma migrate deploy --schema=services/api-gateway/prisma/schema.prisma" || true

            echo "ğŸ§¹ Nettoyage des images Docker inutilisÃ©es..."
            docker image prune -f

            echo "âœ… DÃ©ploiement backend terminÃ©!"

      - name: VÃ©rification santÃ© API
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            sleep 15
            curl -f http://localhost:3001/api/v1/health || exit 1
            echo "âœ… API Gateway opÃ©rationnel!"

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Job 4 : Le frontend est dÃ©ployÃ©
  # automatiquement par Vercel via GitHub
  # (aucune action requise ici)
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  notify-frontend:
    name: Frontend â†’ Vercel (auto)
    runs-on: ubuntu-latest
    needs: lint
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Info dÃ©ploiement Vercel
        run: |
          echo "ğŸš€ Le frontend sera automatiquement dÃ©ployÃ© par Vercel"
          echo "ğŸ“Œ Vercel dÃ©tecte le push sur main et lance le build"
          echo "ğŸŒ URL: https://tikeo.vercel.app"
